# API Key 和安全配置指南

## 概述

本系统新增了安全的 API Key 管理功能，允许用户在设置中配置各个交易所的 API Key 和 Secret Key，用于一键套利交易功能。

## 安全措施

尽管本项目运行在前端环境，我们仍然实施了多层安全保护：

### 1. 加密存储

- **加密算法**: AES-256-GCM（Web Crypto API）
- **密钥推导**: PBKDF2 (100,000 次迭代)
- **盐值处理**: 使用固定应用盐值 + 用户名生成唯一密钥
- **初始化向量**: 每次加密使用随机 IV

### 2. 用户隔离

- 每个用户的配置使用独立的加密密钥
- 存储键包含用户名，确保数据隔离
- 用户登出不会影响其他用户的配置

### 3. 访问控制

- 只有登录用户可以访问设置页面
- 所有用户角色（super、stx、stark）都可以配置自己的 API Key
- 数据在传输和存储时都经过加密处理

### 4. 最佳实践提示

系统会在设置页面提供以下安全提示：
- 只开启 API Key 的交易权限，不开启提现权限
- 定期更换 API Key
- 在公共电脑使用后清除配置
- 提醒用户前端存储的安全限制

## 功能特性

### 1. 支持的交易所

系统支持以下 7 个主流交易所的 API Key 配置：
- 币安 (Binance)
- OKX
- Gate.io
- Bybit
- Bitget
- 火币 (Huobi)
- MEXC

### 2. 配置内容

每个交易所可以配置：
- **API Key**: 交易所分配的 API 密钥
- **Secret Key**: 交易所分配的密钥
- **Base URL**: API 基础地址（可选，有默认值）
- **启用状态**: 是否启用此交易所的 API

### 3. 数据验证

- API Key 长度验证 (16-128 字符)
- Secret Key 长度验证 (16-128 字符)
- Base URL 格式提示

## 使用指南

### 配置 API Key

1. **登录系统**
   ```
   使用您的账户登录区块链监控系统
   ```

2. **进入设置页面**
   ```
   点击顶部导航栏的"设置"菜单
   ```

3. **获取交易所 API Key**
   - 登录对应的交易所网站
   - 进入账户设置 → API 管理
   - 创建新的 API Key
   - **重要**: 只开启"现货交易"权限，不要开启"提现"权限

4. **配置 API Key**
   - 在设置页面展开对应的交易所
   - 输入 API Key 和 Secret Key
   - 选择是否启用
   - 点击"保存配置"

5. **使用一键交易功能**
   - 前往"CEX 套利监控"页面
   - 找到套利机会，点击"交易"按钮
   - 系统会自动使用配置的 API Key 执行交易

### 管理配置

- **查看配置**: 展开对应交易所即可查看（密钥以密文显示）
- **修改配置**: 直接修改后点击"保存配置"
- **删除单个配置**: 点击交易所卡片右上角的"删除配置"
- **清除所有配置**: 在页面底部点击"清除所有配置"（危险操作）

## 技术实现

### 文件结构

```
src/
  utils/
    crypto.ts                  # 加密工具函数
  services/
    settings.ts                # 设置服务（管理 API Key）
  views/
    Settings.tsx               # 设置页面组件
  api/
    cex-trading.ts            # 交易 API（已集成 settings）
  components/
    CexArbitrageMonitor.tsx   # 套利监控（已集成 API Key 检查）
```

### 加密流程

```typescript
// 保存时
1. 用户输入 API Key 和 Secret Key
2. 生成用户专属加密密钥（基于用户名）
3. 使用 AES-GCM 加密数据
4. 存储到 localStorage（加密后的数据）

// 读取时
1. 从 localStorage 获取加密数据
2. 使用用户专属密钥解密
3. 返回明文数据供使用
```

### API 集成

```typescript
// 在 cex-trading.ts 中
import settingsService from '@/services/settings';

// 获取交易所配置
const credentials = await settingsService.getExchangeCredentials('binance');

// 使用配置执行交易
if (credentials?.apiKey && credentials?.secretKey) {
  // 执行交易操作
  await placeMarketBuyOrder(
    exchange,
    symbol,
    amount,
    credentials.apiKey,
    credentials.secretKey
  );
}
```

## 安全注意事项

### ⚠️ 前端存储的限制

虽然我们使用了加密算法，但前端存储本质上无法提供与服务器端相同级别的安全性：

1. **JavaScript 可见性**: 加密/解密代码在浏览器中可见
2. **内存泄露风险**: 密钥在内存中可能被调试工具访问
3. **XSS 攻击**: 跨站脚本攻击可能窃取数据
4. **本地访问**: 有物理访问权限的人可能获取数据

### 🛡️ 建议的安全措施

1. **最小权限原则**
   - 只授予 API Key "现货交易"权限
   - 不要授予"提现"权限
   - 设置 IP 白名单（如果交易所支持）

2. **定期轮换**
   - 每月更换一次 API Key
   - 发现异常时立即更换

3. **使用限制**
   - 不在公共场所配置
   - 使用后及时清除配置
   - 不分享您的 API Key

4. **监控账户**
   - 定期检查交易记录
   - 设置账户安全提醒
   - 使用交易所的安全功能（如 2FA）

### 🔄 未来改进方向

为了提供更好的安全性，可以考虑：

1. **后端代理**: 将 API Key 存储在服务器端，前端通过中间层访问
2. **硬件密钥**: 集成 WebAuthn/U2F 硬件密钥
3. **多因素认证**: 在执行交易前要求额外验证
4. **审计日志**: 记录所有 API Key 的使用情况

## 常见问题

### Q: API Key 会被其他用户看到吗？
A: 不会。每个用户的配置使用独立的加密密钥，相互隔离。

### Q: 清除浏览器缓存会丢失配置吗？
A: 是的。配置存储在 localStorage 中，清除缓存会删除配置。

### Q: 可以在多个设备上使用吗？
A: 需要在每个设备上单独配置，配置不会跨设备同步。

### Q: 忘记删除配置怎么办？
A: 可以在设置页面点击"清除所有配置"，或者直接在交易所端禁用/删除 API Key。

### Q: 系统会上传我的 API Key 吗？
A: 不会。所有数据都存储在本地浏览器中，不会发送到任何服务器。

## 测试建议

在正式使用前，建议：

1. 先在测试网环境测试（如果交易所提供）
2. 使用小额资金进行首次交易测试
3. 验证交易记录是否正确
4. 确认手续费计算是否准确

## 技术支持

如有问题，请：
1. 查看浏览器控制台的错误信息
2. 检查 API Key 权限设置
3. 验证交易所 API 状态
4. 联系系统管理员

---

**免责声明**: 本系统仅供学习和研究使用。加密货币交易存在高风险，请谨慎使用 API Key 功能。开发者不对使用本系统造成的任何损失负责。
